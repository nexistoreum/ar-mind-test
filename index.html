<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Interactive AR Mars - Share Edition</title>

<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
<script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>

<style>
body { margin:0; overflow:hidden; font-family: sans-serif; }

#capture-btn {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.9);
    border-radius: 50%;
    border: 5px solid rgba(0,0,0,0.2);
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 999;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;
    cursor:pointer;
}

#sound-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    width: 45px;
    height: 45px;
    background: rgba(0,0,0,0.6);
    border-radius: 10px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-size:22px;
    z-index:999;
    cursor:pointer;
}

#loader {
    display:none;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background:rgba(0,0,0,0.8);
    color:white;
    padding:20px;
    border-radius:10px;
    z-index:1000;
}
</style>
</head>

<body>

<div id="sound-btn">ðŸ”ˆ</div>
<div id="capture-btn">ðŸ“¸</div>
<div id="loader">Processing...</div>

<a-scene
embedded
renderer="preserveDrawingBuffer: true; antialias: true; alpha: true;"
arjs="sourceType: webcam; debugUIEnabled: false;"
vr-mode-ui="enabled: false"
gesture-detector>

<a-assets>
    <a-asset-item id="mars-model" src="mars_glb-opt.glb"></a-asset-item>
    <audio id="bg-music" src="VENUS_Master.mp3" loop="true"></audio>
</a-assets>

<a-entity id="mars-wrapper"
position="0 1.2 -5"
class="clickable"
gesture-handler="minScale:0.1; maxScale:10">

    <a-entity
    gltf-model="#mars-model"
    scale="1 1 1"
    animation-mixer>
    </a-entity>

</a-entity>

<a-light type="ambient" intensity="1.5"></a-light>
<a-light type="directional" position="1 2 1" intensity="0.5"></a-light>

<a-camera

look-controls="magicWindowTrackingEnabled: true"
raycaster="objects: .clickable"
cursor="rayOrigin: mouse;">
</a-camera>

</a-scene>

<script>

/* =======================
   Variables
======================= */
const soundBtn = document.querySelector('#sound-btn');
const audio = document.querySelector('#bg-music');
const captureBtn = document.querySelector('#capture-btn');
const loader = document.querySelector('#loader');
const mars = document.querySelector('#mars-wrapper');

let isMuted = true;

/* =======================
   Sound Control
======================= */
soundBtn.addEventListener('click', () => {
    if (isMuted) {
        audio.play().catch(()=>{});
        soundBtn.innerText = "ðŸ”Š";
        isMuted = false;
    } else {
        audio.pause();
        soundBtn.innerText = "ðŸ”ˆ";
        isMuted = true;
    }
});

/* =======================
   Capture AR Screenshot
======================= */
captureBtn.addEventListener('click', async () => {

    const sceneEl = document.querySelector('a-scene');
    const video = document.querySelector('video');

    if (!video || !sceneEl.renderer) {
        alert("Camera not ready");
        return;
    }

    loader.style.display = 'block';

    // à¸£à¸­à¹€à¸Ÿà¸£à¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
    await new Promise(resolve => requestAnimationFrame(resolve));

    // à¸šà¸±à¸‡à¸„à¸±à¸š render
    sceneEl.renderer.render(sceneEl.object3D, sceneEl.camera);

    const glCanvas = sceneEl.renderer.domElement;

    const dpr = window.devicePixelRatio || 1;
    const width = window.innerWidth;
    const height = window.innerHeight;

    const captureCanvas = document.createElement('canvas');
    captureCanvas.width = width * dpr;
    captureCanvas.height = height * dpr;

    const ctx = captureCanvas.getContext('2d');
    ctx.scale(dpr, dpr);

    // ===== à¸§à¸²à¸”à¸à¸¥à¹‰à¸­à¸‡à¹à¸šà¸šà¹„à¸¡à¹ˆà¸¢à¸·à¸” à¹„à¸¡à¹ˆà¸„à¸£à¸­à¸› (contain) =====
    const videoRatio = video.videoWidth / video.videoHeight;
    const screenRatio = width / height;

    let drawWidth, drawHeight, offsetX = 0, offsetY = 0;

    if (videoRatio > screenRatio) {
        // à¸§à¸´à¸”à¸µà¹‚à¸­à¸à¸§à¹‰à¸²à¸‡à¸à¸§à¹ˆà¸² â†’ à¸ˆà¸³à¸à¸±à¸”à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡
        drawWidth = width;
        drawHeight = width / videoRatio;
        offsetY = (height - drawHeight) / 2;
    } else {
        // à¸§à¸´à¸”à¸µà¹‚à¸­à¸ªà¸¹à¸‡à¸à¸§à¹ˆà¸² â†’ à¸ˆà¸³à¸à¸±à¸”à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡
        drawHeight = height;
        drawWidth = height * videoRatio;
        offsetX = (width - drawWidth) / 2;
    }

    ctx.drawImage(video, offsetX, offsetY, drawWidth, drawHeight);


    // ===== à¸§à¸²à¸”à¹‚à¸¡à¹€à¸”à¸¥ WebGL à¹à¸šà¸šà¹„à¸¡à¹ˆà¸¢à¸·à¸” =====
    const glRatio = glCanvas.width / glCanvas.height;

    let glDrawWidth, glDrawHeight, glOffsetX = 0, glOffsetY = 0;

    if (glRatio > screenRatio) {
        glDrawHeight = height;
        glDrawWidth = glDrawHeight * glRatio;
        glOffsetX = -(glDrawWidth - width) / 2;
    } else {
        glDrawWidth = width;
        glDrawHeight = glDrawWidth / glRatio;
        glOffsetY = -(glDrawHeight - height) / 2;
    }

    ctx.drawImage(
        glCanvas,
        0, 0,
        glCanvas.width,
        glCanvas.height,
        glOffsetX,
        glOffsetY,
        glDrawWidth,
        glDrawHeight
    );


    captureCanvas.toBlob(async (blob) => {

        loader.style.display = 'none';

        const file = new File([blob], "ar.png", { type:"image/png" });

        if (navigator.canShare && navigator.canShare({ files:[file] })) {
            try {
                await navigator.share({
                    files:[file],
                    title:"AR",
                    text:"Captured with AR"
                });
            } catch(e){}
        } else {
            const link = document.createElement('a');
            link.download = "ar.png";
            link.href = captureCanvas.toDataURL();
            link.click();
        }

    }, 'image/png');
});

/* =======================
   Drag Zoom (Simple)
======================= */
let startY = 0;
let startScale = 1;
const sensitivity = 0.005;

window.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
        startY = e.touches[0].pageY;
        startScale = mars.getAttribute('scale').x;
    }
});

window.addEventListener('touchmove', (e) => {
    if (e.touches.length === 1) {
        let diffY = startY - e.touches[0].pageY;
        let newScale = startScale - (diffY * sensitivity);
        newScale = Math.min(Math.max(newScale, 0.1), 10);
        mars.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
    }
});

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interactive AR Mars</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        #instructions {
            position: fixed; bottom: 80px; width: 100%;
            text-align: center; color: white; z-index: 10;
            font-family: sans-serif; pointer-events: none;
            text-shadow: 1px 1px 2px black;
        }

        /* à¸›à¸¸à¹ˆà¸¡à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸› */
        #capture-btn {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            width: 60px; height: 60px;
            background: white; border-radius: 50%;
            border: 5px solid rgba(255,255,255,0.5);
            z-index: 100; cursor: pointer;
        }

        /* à¸›à¸¸à¹ˆà¸¡à¹€à¸ªà¸µà¸¢à¸‡ */
        #sound-btn {
            position: fixed; top: 20px; left: 20px;
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.5); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            z-index: 100; cursor: pointer; color: white; font-size: 24px;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    
    <div id="sound-btn">ðŸ”Š</div>
    <div id="capture-btn"></div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; preserveDrawingBuffer: true;"
        vr-mode-ui="enabled: false"
        gesture-detector>

        <a-assets>
            <a-asset-item id="mars-model" src="mars_glb-opt.glb"></a-asset-item>
            <audio id="bg-music" src="VENUS_Master.mp3" loop="true"></audio>
        </a-assets>

        <a-entity 
            id="mars-wrapper"
            position="0 1.2 -5" 
            class="clickable"
            gesture-handler="minScale: 0.1; maxScale: 10">
            
            <a-entity 
                id="mars-model-entity"
                gltf-model="#mars-model" 
                scale="1 1 1"
                animation-mixer>
            </a-entity>
        </a-entity>

        <a-light type="ambient" intensity="1.5"></a-light>
        <a-light type="directional" position="1 2 1" intensity="0.5"></a-light>

        <a-camera 
            id="camera" 
            look-controls 
            raycaster="objects: .clickable" 
            cursor="rayOrigin: mouse;">
        </a-camera>

    </a-scene>

    <script>
        // --- à¸£à¸°à¸šà¸šà¹€à¸ªà¸µà¸¢à¸‡ ---
        const soundBtn = document.querySelector('#sound-btn');
        const audio = document.querySelector('#bg-music');
        let isMuted = true;

        soundBtn.addEventListener('click', () => {
            if (isMuted) {
                audio.play();
                soundBtn.innerText = 'ðŸ”Š';
                isMuted = false;
            } else {
                audio.pause();
                soundBtn.innerText = 'ðŸ”ˆ';
                isMuted = true;
            }
        });

        // --- à¸£à¸°à¸šà¸šà¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸› (à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¹à¸à¹‰à¸—à¸²à¸‡à¹€à¸—à¸„à¸™à¸´à¸„) ---
        const captureBtn = document.querySelector('#capture-btn');
        captureBtn.addEventListener('click', () => {
            const scene = document.querySelector('a-scene');
            const video = document.querySelector('video'); // à¸”à¸¶à¸‡ Video à¸ˆà¸²à¸ AR.js
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 1. à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸‚à¸™à¸²à¸” Canvas à¹ƒà¸«à¹‰à¹€à¸—à¹ˆà¸²à¸à¸±à¸šà¸‚à¸™à¸²à¸”à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸ˆà¸£à¸´à¸‡
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // 2. à¸§à¸²à¸”à¸ à¸²à¸žà¸ˆà¸²à¸à¸à¸¥à¹‰à¸­à¸‡à¸¥à¸‡à¹„à¸›à¸à¹ˆà¸­à¸™
            if (video) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }

            // 3. à¸§à¸²à¸”à¹‚à¸¡à¹€à¸”à¸¥ 3D à¸—à¸±à¸šà¸¥à¸‡à¹„à¸›
            const sceneCanvas = scene.components.screenshot.getCanvas('perspective');
            ctx.drawImage(sceneCanvas, 0, 0, canvas.width, canvas.height);

            // 4. à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¸ à¸²à¸žà¹à¸¥à¸°à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”
            try {
                const dataURL = canvas.toDataURL("image/png");
                const link = document.createElement('a');
                link.download = 'mars-ar-capture.png';
                link.href = dataURL;
                link.click();
            } catch (err) {
                alert("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸šà¸±à¸™à¸—à¸¶à¸à¸ à¸²à¸žà¹„à¸”à¹‰à¹‚à¸”à¸¢à¸•à¸£à¸‡à¸šà¸™à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œà¸™à¸µà¹‰ à¸à¸£à¸¸à¸“à¸²à¹ƒà¸Šà¹‰à¸à¸²à¸£à¹à¸„à¸›à¸«à¸™à¹‰à¸²à¸ˆà¸­à¹à¸—à¸™à¸„à¸£à¸±à¸š");
            }
        });

        // --- Gesture à¹€à¸”à¸´à¸¡à¸‚à¸­à¸‡à¸„à¸¸à¸“ ---
        let startY = 0;
        let startScale = 1;
        const mars = document.querySelector('#mars-wrapper');
        const sensitivity = 0.005;

        window.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                startY = e.touches[0].pageY;
                startScale = mars.getAttribute('scale').x;
            }
        });

        window.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1) {
                let currentY = e.touches[0].pageY;
                let diffY = startY - currentY;
                let newScale = startScale - (diffY * sensitivity);
                newScale = Math.min(Math.max(newScale, 0.1), 10); 
                mars.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
            }
        });
    </script>
</body>
</html>
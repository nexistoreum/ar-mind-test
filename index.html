<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interactive AR Mars - Full Version</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        
        /* ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ */
        #instructions {
            position: fixed; bottom: 100px; width: 100%;
            text-align: center; color: white; z-index: 10;
            pointer-events: none; text-shadow: 1px 1px 2px black;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ */
        #capture-btn {
            position: fixed; bottom: 25px; left: 50%;
            transform: translateX(-50%);
            width: 70px; height: 70px;
            background: white; border-radius: 50%;
            border: 5px solid rgba(255,255,255,0.5);
            z-index: 100; cursor: pointer;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #capture-btn:active { transform: translateX(-50%) scale(0.9); }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
        #sound-btn {
            position: fixed; top: 20px; left: 20px;
            width: 45px; height: 45px;
            background: rgba(0,0,0,0.6); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 100; cursor: pointer; color: white; font-size: 20px;
            border: 2px solid white;
        }

        /* ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Preview ‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ */
        #preview-container {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #preview-img {
            width: 85%; border: 4px solid white; border-radius: 10px;
            max-height: 65%; object-fit: contain; background: #222;
        }
        .preview-btns { margin-top: 25px; display: flex; gap: 15px; }
        .btn-ui {
            padding: 12px 25px; border-radius: 30px; border: none;
            font-weight: bold; cursor: pointer; font-size: 16px;
        }
        #close-btn { background: #555; color: white; }
        #save-btn { background: #007bff; color: white; text-decoration: none; display: inline-block; }
        
        .tip-text { color: #aaa; font-size: 12px; margin-top: 10px; text-align: center; }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">

    <div id="sound-btn">üîá</div>
    <div id="capture-btn"></div>
    <div id="instructions">‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô | ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢</div>

    <div id="preview-container">
        <h3 style="color: white; margin-bottom: 10px;">‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
        <img id="preview-img" src="">
        <p class="tip-text">* ‡∏´‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
        <div class="preview-btns">
            <button id="close-btn" class="btn-ui">‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
            <a id="save-link" download="mars-ar-photo.png">
                <button id="save-btn" class="btn-ui">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</button>
            </a>
        </div>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; preserveDrawingBuffer: true;"
        vr-mode-ui="enabled: false"
        gesture-detector>

        <a-assets>
            <a-asset-item id="mars-model" src="mars_glb-opt.glb"></a-asset-item>
            <audio id="bg-music" src="VENUS_Master.mp3" loop="true" crossorigin="anonymous"></audio>
        </a-assets>

        <a-entity 
            id="mars-wrapper"
            position="0 1.2 -5" 
            class="clickable"
            gesture-handler="minScale: 0.1; maxScale: 10">
            
            <a-entity 
                id="mars-model-entity"
                gltf-model="#mars-model" 
                scale="1 1 1"
                animation-mixer>
            </a-entity>
        </a-entity>

        <a-light type="ambient" intensity="1.2"></a-light>
        <a-light type="directional" position="1 2 1" intensity="0.8"></a-light>

        <a-camera 
            id="camera" 
            look-controls="enabled: false" 
            raycaster="objects: .clickable" 
            cursor="rayOrigin: mouse;">
        </a-camera>

    </a-scene>

    <script>
        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á ---
        const soundBtn = document.querySelector('#sound-btn');
        const audio = document.querySelector('#bg-music');
        let isMuted = true;

        soundBtn.addEventListener('click', () => {
            if (isMuted) {
                audio.play().catch(e => console.log("Audio play failed"));
                soundBtn.innerText = 'üîä';
                isMuted = false;
            } else {
                audio.pause();
                soundBtn.innerText = 'üîá';
                isMuted = true;
            }
        });

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞ Preview ---
        const captureBtn = document.querySelector('#capture-btn');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-img');
        const closeBtn = document.getElementById('close-btn');
        const saveLink = document.getElementById('save-link');

        captureBtn.addEventListener('click', () => {
            // 1. ‡πÅ‡∏ü‡∏•‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            const flash = document.createElement('div');
            flash.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;";
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 150);

            // 2. ‡∏ú‡∏™‡∏°‡∏†‡∏≤‡∏û (‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡πÇ‡∏°‡πÄ‡∏î‡∏•)
            const scene = document.querySelector('a-scene');
            const video = document.querySelector('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // ‡∏ß‡∏≤‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
            if (video) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }

            // ‡∏ß‡∏≤‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• 3D ‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ
            const sceneCanvas = scene.components.screenshot.getCanvas('perspective');
            ctx.drawImage(sceneCanvas, 0, 0, canvas.width, canvas.height);

            // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Preview
            const dataURL = canvas.toDataURL("image/png");
            previewImg.src = dataURL;
            saveLink.href = dataURL;
            previewContainer.style.display = 'flex';
        });

        closeBtn.addEventListener('click', () => {
            previewContainer.style.display = 'none';
        });

        // --- ‡∏£‡∏∞‡∏ö‡∏ö Touch Zoom/Rotate ---
        let startY = 0;
        let startScale = 1;
        const mars = document.querySelector('#mars-wrapper');
        const sensitivity = 0.005;

        window.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                startY = e.touches[0].pageY;
                startScale = mars.getAttribute('scale').x;
            }
        });

        window.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1) {
                let currentY = e.touches[0].pageY;
                let diffY = startY - currentY;
                let newScale = startScale - (diffY * sensitivity);
                newScale = Math.min(Math.max(newScale, 0.1), 10); 
                mars.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interactive AR Mars - Share Edition</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>

    <style>
        body { margin:0; overflow:hidden; font-family: sans-serif; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ */
        #capture-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            border: 5px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 999;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #capture-btn:active { transform: translateX(-50%) scale(0.9); }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
        #sound-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            z-index: 999;
            cursor: pointer;
        }

        /* ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏ã‡∏ü‡∏£‡∏π‡∏õ */
        #loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
    </style>
</head>

<body>

<div id="sound-btn">üîà</div>
<div id="capture-btn">üì∏</div>
<div id="loader">Processing...</div>

<a-scene
    embedded
    renderer="preserveDrawingBuffer: true; antialias: true; alpha: true;"
    arjs="sourceType: webcam; debugUIEnabled: false;"
    vr-mode-ui="enabled: false"
    gesture-detector>

    <a-assets>
        <a-asset-item id="mars-model" src="mars_glb-opt.glb"></a-asset-item>
        <audio id="bg-music" src="VENUS_Master.mp3" loop="true"></audio>
    </a-assets>

    <a-entity 
        id="mars-wrapper"
        position="0 1.2 -5"
        class="clickable"
        gesture-handler="minScale: 0.1; maxScale: 10">

        <a-entity
            gltf-model="#mars-model"
            scale="1 1 1"
            animation-mixer>
        </a-entity>

    </a-entity>

    <a-light type="ambient" intensity="1.5"></a-light>
    <a-light type="directional" position="1 2 1" intensity="0.5"></a-light>

    <a-camera
        look-controls
        raycaster="objects: .clickable"
        cursor="rayOrigin: mouse;">
    </a-camera>

</a-scene>

<script>
/* =====================
   1. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
===================== */
const soundBtn = document.querySelector('#sound-btn');
const audio = document.querySelector('#bg-music');
let isMuted = true;

soundBtn.addEventListener('click', () => {
    if (isMuted) {
        audio.play().catch(e => console.log("Audio play failed", e));
        soundBtn.innerText = "üîä";
        isMuted = false;
    } else {
        audio.pause();
        soundBtn.innerText = "üîà";
        isMuted = true;
    }
});

/* =====================
   2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ & Share (The Pop-up Magic)
===================== */
captureBtn.addEventListener('click', async () => {

    const sceneEl = document.querySelector('a-scene');
    const video = document.querySelector('video');

    if (!video || !sceneEl.renderer) {
        alert("Camera not ready");
        return;
    }

    loader.style.display = 'block';

    // üî• ‡∏£‡∏≠‡πÉ‡∏´‡πâ render frame ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
    await new Promise(resolve => requestAnimationFrame(resolve));

    // üî• ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö render ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
    sceneEl.renderer.render(sceneEl.object3D, sceneEl.camera);

    const glCanvas = sceneEl.renderer.domElement;

    // üî• ‡πÉ‡∏ä‡πâ DPR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏Ñ‡∏°
    const dpr = window.devicePixelRatio || 1;

    const captureCanvas = document.createElement('canvas');
    captureCanvas.width = window.innerWidth * dpr;
    captureCanvas.height = window.innerHeight * dpr;

    const ctx = captureCanvas.getContext('2d');
    ctx.scale(dpr, dpr);

    // ===== 1Ô∏è‚É£ ‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á =====
    ctx.drawImage(
        video,
        0,
        0,
        window.innerWidth,
        window.innerHeight
    );

    // ===== 2Ô∏è‚É£ ‡∏ß‡∏≤‡∏î WebGL (‡πÇ‡∏°‡πÄ‡∏î‡∏• AR) =====
    ctx.drawImage(
        glCanvas,
        0,
        0,
        glCanvas.width,
        glCanvas.height,
        0,
        0,
        window.innerWidth,
        window.innerHeight
    );

    // ===== 3Ô∏è‚É£ Export =====
    captureCanvas.toBlob(async (blob) => {

        loader.style.display = 'none';

        const file = new File([blob], "mars-ar.png", { type: "image/png" });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'Mars AR',
                    text: 'Captured with AR'
                });
            } catch (err) {
                console.log(err);
            }
        } else {
            const link = document.createElement('a');
            link.download = "mars-ar.png";
            link.href = captureCanvas.toDataURL();
            link.click();
        }

    }, 'image/png');

});




/* =====================
   3. ‡∏£‡∏∞‡∏ö‡∏ö Pinch to Zoom (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°)
===================== */
let startY = 0;
let startScale = 1;
const mars = document.querySelector('#mars-wrapper');
const sensitivity = 0.005;

window.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
        startY = e.touches[0].pageY;
        startScale = mars.getAttribute('scale').x;
    }
});

window.addEventListener('touchmove', (e) => {
    if (e.touches.length === 1) {
        let diffY = startY - e.touches[0].pageY;
        let newScale = startScale - (diffY * sensitivity); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏¢‡∏≤‡∏¢
        newScale = Math.min(Math.max(newScale, 0.1), 10);
        mars.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
    }
});

</script>

</body>
</html>